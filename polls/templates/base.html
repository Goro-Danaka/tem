<head>
<title>Scraper scripts</title>
{% load bootstrap3 %}
{% bootstrap_css %}
{% bootstrap_javascript jquery=1 %}
{% load static %}

<link rel="stylesheet" type="text/css" href="{% static 'style.css' %}" />
<body>
<div class="container">
    {% block page_header %}
    {% endblock %}
    {% block add_website_modal %}{% endblock %}
    {% block delete_confirm_modal %}{% endblock %}
    {% block scraper_settings_modal %}{% endblock %}
    <div class="form-group nav-padding">
      <label for="scrapes">Select scraper script:</label>
        {% csrf_token %}
      <select class="form-control" id="scrapers">
        {% if scripts_list %}
            {% for script in scripts_list %}
                <option value="{{ script.name }}">{{ script.name }}</option>
            {% endfor %}
        {% else %}
            <option>No scripts are available.</option>
        {% endif %}
      </select>
    </div>
    <div class="form-group nav-padding">
      <label for="logs">Logs:</label>
      <textarea class="form-control" rows="10" id="logs"></textarea>
    </div>
    <div class="col-xs-12 col-sm-12 navigation-control">
        <div class="progress" style="display: none;">
          <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:100%">
              Job in progress
          </div>
        </div>
        <button id="start_button" class="btn btn-size btn-default pull-left">Start</button>
        {% block add_button %}{% endblock %}
        {% block delete_button %}{% endblock %}
        {% block scraper_settings_button %}{% endblock %}
    </div>
    <script>
    $(document).ready(function() {
        function update_status(in_progress, messages, result_files){
          if (in_progress) {
            $('#start_button').prop('disabled', true);
            $('#results_button').prop('disabled', true);
            $('#scrapers').prop( "disabled", true);
            $('.progress').show()
          }
          else {
            $('#start_button').prop('disabled', false);
            $('#results_button').prop('disabled', false);
            $('#scrapers').prop( "disabled", false);
            $('.progress').hide()
          }
          if (messages !== null){
            $('#logs').append(messages);
          }
          $('.list-group-item').remove();

          for (var i=0; i < result_files.length; i++){
            if (i == 0) {
               $("#filesList").append('<a href="#" class="list-group-item active">'+result_files[i]+'</a>');
            }
            else {
               $("#filesList").append('<a href="#" class="list-group-item">'+result_files[i]+'</a>');
            }
          }

          $('.list-group-item').click(function() {
            var $this = $(this);

            $('.active').removeClass('active');
            $this.toggleClass('active')
          })
        }


       $("#start_button").click(function(event){
            var selected_script = $('#scrapers').find(":selected").val();
            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
            $('#logs').append(selected_script + ' script job started.\n');
            $.ajax({
                 type:"POST",
                 url:"start/",
                 data: {
                        'selected_script': selected_script,
                        'csrfmiddlewaretoken': csrf,
                        },
                 complete: function() {
                     $('#logs').append(selected_script + ' script job completed.\n');
                 }
            });
        });

        $("#download").click(function(event){
            var file_name = $('.list-group-item.active').text();
            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                 type:"POST",
                 url:"download/",
                 data: {
                        'file_name': file_name,
                        'csrfmiddlewaretoken': csrf,
                        },
                 success: function (data) {
                      var element = document.createElement('a');
                        element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(data));
                        element.setAttribute('download', file_name);
                        element.style.display = 'none';
                        document.body.appendChild(element);
                        element.click();
                        document.body.removeChild(element);
                 }
            });
       });

       $("#delete").click(function(event){
            var selected_script = $('#scrapers').find(":selected").val();
            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
            $.ajax({
                 type:"POST",
                 url:"delete/",
                 data: {
                        'selected_script': selected_script,
                        'file_id': file_id,
                        'csrfmiddlewaretoken': csrf,
                        },
                 success: function (data) {
                    if ($(file).parent().length) {
                     alert('yes')
                     }
                 }
            });
       });

       (function get_status() {
          var csrf = $('input[name="csrfmiddlewaretoken"]').val();
          $.ajax({
            type: "POST",
            url: 'status/',
            data: {'csrfmiddlewaretoken': csrf },
            success: function(data) {
              var in_progress = data['in_progress']
              var messages = data['messages']
              var result_files = data['result_files']
              update_status(in_progress, messages, result_files)
            },
            complete: function() {
              setTimeout(get_status, 5000);
            }
          });
        })();
    });
</script>
</div>
</body>
</head>